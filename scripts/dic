#!/bin/bash

dic_dir="/home/jkarng/Project/dic/mp3"
daum="https://dic.daum.net/search.do?q"
all_audios="${dic_dir}/*.mp3"

function getWd(){
  curl -s -A 'Mozilla/4.0' "${daum}=${1}"|\
  sed -En '/wordid/!b;p;q' |\
  sed -E 's/>([^<]+)<|./\1/g'
}

function dicInit(){
  W1=${1%%.*}
  W1=${W1##*/}
  W1=${W1%%-*}
  W1=${W1%%_*}
  WD=$( getWd $W1 )

  wd_audio="${dic_dir}/${WD}.mp3"

  if [[ ${WD} != ${W1} ]] 
    then clear; echo "=== Did u mean ${WD}, can't find the ${W1} ===";sleep 2
  fi
}

function printDic(){
    echo "####### ${W1} #######" && \
    curl -s -A 'Mozilla/4.0' "${daum}=${WD}" |\
    awk '{str=gensub(/>([^<]+)<|./,"\\1","g");print str}'
    #sed -E 's/>([^<]+)<|./\1/g' |\
    #sed -En '/^\S/p' |\
    #sed -En '/^[0-9]|^[a-z]/p' |\
    #sed -En 'N;/^[0-9]/hp'
    #sed -En '/완료/,/영영사전 더보기/p'

    echo "================ END ==================="
}
dicInit $1
printDic 
exit

function playall(){
  for i in ${all_audios}; do echo ${i##*/}; mpv ${i} > /dev/null 2>&1;  sleep 1; mpv ${i} > /dev/null 2>&1; sleep 1; mpv ${i} > /dev/null 2>&1; done
}

#####################
dicInit $1

if [[ ${#} -eq 0 ]]; then
  playall 

elif [[ -f ${wd_audio} ]]; then
  printDic ${wd_audio}
  for i in {1..5}; do mpv ${wd_audio} ; sleep 1; done

  for i in ${all_audios} 
    do
      #clear 
      printDic ${i}
  
      mpv "${i}" > /dev/null 2>&1
      sleep 1
      mpv "${i}" > /dev/null 2>&1
      sleep 1
      mpv "${i}" > /dev/null 2>&1
      sleep 1
    done
else
  printDic ${WD}
  curl -s -A 'Mozilla/4.0' "${daum}=${WD}" | \
  awk -F "\"" '/txt_pronounce/{print $4;exit}' | \
  xargs -I{} curl -o "${dic_dir}/${WD}.mp3" {} && \
  for i in {1..5}; do mpv ${wd_audio}; sleep 1; done
fi

