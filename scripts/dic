#!/bin/bash
function trimArg(){
    W1=${1%%.*}
    W2=${W1##*/}

    W3=${W2%%-*}
    W4=${W3%%_*}

    W=$( ./getWID.sh $W4 )
    WD=${W##*>}
    WID=${W%%>*}
}

function main(){

daum="https://dic.daum.net/search.do?q"
daum_id="https://dic.daum.net/word/view.do?wordid" #=ekw000146827

dic_dir="~/Project/dic/mp3"
all_audios="${dic_dir}/*.mp3"

trimArg $1

if [[ ${WD} != ${1} ]] 
  then clear; echo "=== Did you mean ${WD}, can't find the ${W1} ===";sleep 2
fi

  wd_audio="${dic_dir}/${W2}.mp3"

  if [[ ${#} -eq 0 ]]; then
    playall 

  elif [[ -f ${wd_audio} ]]; then
    printDic ${wd_audio}
    for i in {1..5}; do mpv ${wd_audio} > /dev/null 2>&1 ; sleep 1; done

    for i in ${all_audios} 
      do
        echo -e "$i"
        mpv "${i}" > /dev/null 2>&1
        sleep 1
        echo -e "===>\\t ${W2} \\t<==="
        mpv "${i}" > /dev/null 2>&1
        sleep 1
        mpv "${i}" > /dev/null 2>&1
        echo -e "${i}"
        sleep 1
        clear
      done
  else
    printDic $1

  fi
}

function getWord(){
  curl -s -A 'Mozilla/4.0' "${daum}=${W4}" |\
  sed -En '/wordid/!b;p;q' |\
  sed -E 's/>([^<]+)<|./\1/g'
}

function printDic(){
    trimArg $1
    echo "####### ${W2} #######" 

    curl -s -A 'Mozilla/4.0' "${daum_id}=${WID}" |\
    sed -En '/완료/,/영영사전 더보기/{s/완료/'"${WD}"'/;p}'|\
    sed -E 's/>([^<]+)<|./\1/g' |\
    sed -En '/^\S/p' |\
    sed -En '
        $!N

        /^[^0-9]/ { /\n[0-9]/ bX}
        /^[0-9]/  { /\n[0-9]/ bX}
        /^[0-9]/  { /\n[^0-9]/bX}

        bY
        :X
        s/^[0-9].*/\t&/
        P
        D

        :Y 
        D
        '

    echo "======= END of $WD ==================="

}

function playall(){
  for i in ${all_audios}; do echo ${i}; mpv ${i} > /dev/null 2>&1;  sleep 1; mpv ${i} > /dev/null 2>&1; sleep 1; mpv ${i} > /dev/null 2>&1; done
}

#####################
main $1

