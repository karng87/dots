#!/bin/bash

function main(){

dic_dir="~/Project/dic/mp3"
daum="https://dic.daum.net/search.do?q"
all_audios="${dic_dir}/*.mp3"

W1=${1%%.*}
W2=${W1##*/}

W3=${W2%%-*}
W4=${W3%%_*}
WD=$(getWord $W4)

if [[ ${WD} != ${1} ]] 
  then clear; echo "=== Did u mean ${WD}, can't find the ${W1} ===";sleep 2
fi

  wd_audio="${dic_dir}/${W2}.mp3"

  echo "$wd_audio"

  if [[ ${#} -eq 0 ]]; then
    echo playall
    playall 

  elif [[ -f ${wd_audio} ]]; then
    printDic ${wd_audio}
    exit
    for i in {1..5}; do mpv ${wd_audio} ; sleep 1; done

    for i in ${all_audios} 
      do
        clear 
        echo -e "\\n\\t ${W2}"
        mpv "${i}" > /dev/null 2>&1
        sleep 1
        mpv "${i}" > /dev/null 2>&1
        sleep 1
        mpv "${i}" > /dev/null 2>&1
        sleep 1
      done
  else
    printDic 
  fi
  echo end_func...
}

function getWord(){
  curl -s -A 'Mozilla/4.0' "${daum}=${W4}" |\
  sed -En '/wordid/!b;p;q' |\
  sed -E 's/>([^<]+)<|./\1/g'
}

function printDic(){

    echo "####### ${W2} #######" 

    curl -s -A 'Mozilla/4.0' "${daum}=${WD}" |\
    sed -En '/완료/,/영영사전 더보기/p' |\
    sed -E 's/>([^<]+)<|./\1/g' |\
    sed -En '/^\S/p' |\
    #sed -En '/^[[가-힣]/!p' |\
    sed -En '
        :X
        $!N
        /\n[0-9]\./{
          P
          D
          bX
        }

        :Y
        $!N
        D
        '

    #sed -En '/^[0-9]|^[a-z]/p' |\
    #sed -En 'N;/^[0-9]/hp'

    echo "================ END ==================="
}

function playall(){
  for i in ${all_audios}; do j=${i##*/};j=${j%%.*};echo ${j}; mpv ${i} > /dev/null 2>&1;  sleep 1; mpv ${i} > /dev/null 2>&1; sleep 1; mpv ${i} > /dev/null 2>&1; done
}

#####################
main $1

exit
if [[ ${#} -eq 0 ]]; then
  playall 

elif [[ -f ${wd_audio} ]]; then
  printDic ${wd_audio}
  for i in {1..5}; do mpv ${wd_audio} ; sleep 1; done

  for i in ${all_audios} 
    do
      #clear 
      printDic ${i}
  
      mpv "${i}" > /dev/null 2>&1
      sleep 1
      mpv "${i}" > /dev/null 2>&1
      sleep 1
      mpv "${i}" > /dev/null 2>&1
      sleep 1
    done
else
  printDic ${WD}
  curl -s -A 'Mozilla/4.0' "${daum}=${WD}" | \
  awk -F "\"" '/txt_pronounce/{print $4;exit}' | \
  xargs -I{} curl -o "${dic_dir}/${WD}.mp3" {} && \
  for i in {1..5}; do mpv ${wd_audio}; sleep 1; done
fi

